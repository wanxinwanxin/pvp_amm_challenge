name: Economic Correctness Tests

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'amm_competition/**/*.py'
      - 'tests/**/*.py'
      - 'pyproject.toml'
      - 'pytest.ini'
      - '.github/workflows/economic-tests.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'amm_competition/**/*.py'
      - 'tests/**/*.py'
      - 'pyproject.toml'
      - 'pytest.ini'
      - '.github/workflows/economic-tests.yml'
  workflow_dispatch:  # Allow manual triggering

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10

    strategy:
      fail-fast: false  # Continue testing other versions even if one fails
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.10', '3.11', '3.12']
        include:
          # Add macOS for one Python version to catch platform-specific issues
          - os: macos-latest
            python-version: '3.11'

    steps:
      # ======================================================================
      # Setup
      # ======================================================================

      - name: Check out repository
        uses: actions/checkout@v4
        with:
          # Fetch minimal history for faster checkout
          fetch-depth: 1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          # Cache pip dependencies
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml

      # ======================================================================
      # Dependencies
      # ======================================================================

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e ".[dev]"
          pip install pytest-cov pytest-xdist pytest-timeout

      - name: Display Python environment
        run: |
          python --version
          pip --version
          pip list

      # ======================================================================
      # Run Tests
      # ======================================================================

      - name: Run unit tests (fee tiers)
        run: |
          pytest tests/test_fee_tiers.py -v --tb=short
        timeout-minutes: 2

      - name: Run backward compatibility tests
        run: |
          pytest tests/test_backward_compatibility.py -v --tb=short -m backward_compat
        timeout-minutes: 3

      - name: Run symmetry and fairness tests
        run: |
          pytest tests/test_symmetry_fairness.py -v --tb=short -m economic
        timeout-minutes: 3
        if: always()  # Run even if previous step fails

      - name: Run economic property tests
        run: |
          pytest tests/ -v --tb=short -m "economic and not slow" --ignore=tests/test_backward_compatibility.py --ignore=tests/test_symmetry_fairness.py
        timeout-minutes: 3
        if: always()

      - name: Run edge case tests
        run: |
          pytest tests/ -v --tb=short -m "edge_case and not slow"
        timeout-minutes: 2
        if: always()

      # ======================================================================
      # Coverage
      # ======================================================================

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov=amm_competition \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-branch \
            --tb=short \
            -m "not slow"
        timeout-minutes: 5

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: economic-tests-${{ matrix.python-version }}
          name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}
          fail_ci_if_error: false  # Don't fail if Codecov upload fails
        if: always()

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-${{ matrix.os }}-py${{ matrix.python-version }}
          path: htmlcov/
          retention-days: 7
        if: always()

      # ======================================================================
      # Test Results
      # ======================================================================

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            .pytest_cache/
            test-results.xml
          retention-days: 7
        if: always()

  # ==========================================================================
  # Slow Tests (Run separately to keep main workflow fast)
  # ==========================================================================

  slow-tests:
    name: Slow Tests (Python 3.11)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pytest-timeout

      - name: Run slow tests
        run: |
          pytest tests/ -v --tb=short -m slow
        timeout-minutes: 12

  # ==========================================================================
  # Summary
  # ==========================================================================

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, slow-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Fast tests: ${{ needs.test.result }}"
          echo "Slow tests: ${{ needs.slow-tests.result }}"

          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "❌ Fast tests failed"
            exit 1
          fi

          if [ "${{ needs.slow-tests.result }}" != "success" ]; then
            echo "⚠️ Slow tests failed (non-blocking)"
          fi

          echo "✅ All required tests passed"

  # ==========================================================================
  # Performance Check
  # ==========================================================================

  performance:
    name: Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pytest-benchmark

      - name: Run performance benchmarks
        run: |
          # Check that fast tests complete in < 5 minutes
          timeout 300 pytest tests/ -m "not slow" --tb=short -q || {
            echo "❌ Tests took longer than 5 minutes"
            exit 1
          }
          echo "✅ Fast tests completed within 5-minute target"

      - name: Check for slow unmarked tests
        run: |
          # Run tests and identify any that take > 5 seconds without @pytest.mark.slow
          pytest tests/ --durations=0 -q | grep -E "^[0-9.]+ s call.*test_" | awk '$1 > 5 {print}' > slow_tests.txt || true

          if [ -s slow_tests.txt ]; then
            echo "⚠️ Found tests taking > 5s without @pytest.mark.slow marker:"
            cat slow_tests.txt
            echo "Consider marking these tests with @pytest.mark.slow"
          else
            echo "✅ All slow tests are properly marked"
          fi

  # ==========================================================================
  # Lint and Type Check
  # ==========================================================================

  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Run ruff (linter)
        run: |
          ruff check tests/ amm_competition/ --output-format=github
        continue-on-error: true

      - name: Run ruff (formatter check)
        run: |
          ruff format --check tests/ amm_competition/
        continue-on-error: true

      - name: Run mypy (type checker)
        run: |
          mypy tests/ amm_competition/ --ignore-missing-imports
        continue-on-error: true
